.. _usage:

*****
Usage
*****

.. code-block:: text

        usage: e3sm_to_cmip [-h]

        Convert ESM model output into CMIP compatible format

        optional arguments:
        -h, --help            show this help message and exit
        -v  [ ...], --var-list  [ ...]
                                Space separated list of variables to convert from e3sm to cmip. Use 'all' to convert all variables or the name of a CMIP6 table to run all handlers from that table
        -i , --input-path     Path to directory containing e3sm time series data files. Additionally namelist, restart, and mappings files if handling MPAS data.
        -o , --output-path    Where to store cmorized output
        --simple              Perform a simple translation of the E3SM output to CMIP format, but without the CMIP6 metadata checks
        -f FREQ, --freq FREQ  The frequency of that data, default is monthly. Accepted values are mon, day, 6hr, 3hr, 1hr
        -u <user_input_json_path>, --user-metadata <user_input_json_path>
                                Path to user json file for CMIP6 metadata, required unless the --simple flag is used
        -t <tables-path>, --tables-path <tables-path>
                                Path to directory containing CMOR Tables directory, required unless the --simple flag is used
        --map <map_mpas_to_std_grid>
                                The path to an mpas remapping file. Required if mode is mpaso or mpassi
        -n <nproc>, --num-proc <nproc>
                                optional: number of processes, default = 6
        -H <handler_path>, --handlers <handler_path>
                                Path to cmor handlers directory, default = e3sm_to_cmip/cmor_handlers
        --custom-metadata CUSTOM_METADATA
                                the path to a json file with additional custom metadata to add to the output files
        -s, --serial          Run in serial mode, usefull for debugging purposes
        --debug               Set output level to debug
        --mode <mode>         The component to analyze, atm, lnd, mpaso or mpassi
        --logdir LOGDIR       Where to put the logging output from CMOR
        --timeout TIMEOUT     Exit with code -1 if execution time exceeds given time in seconds
        --precheck PRECHECK   Check for each variable if its already in the output CMIP6 directory, only run variables that dont have CMIP6 output
        --info                Print information about the variables passed in the --var-list argument and exit without doing any processing. There are three modes for getting the info, if you just pass the --info flag with the --var-list then it will print out the information for the
                                requested variable. If the --freq <frequency> is passed along with the --tables-path, then the CMIP6 tables will get checked to see if the requested variables are present in the CMIP6 table matching the freq. If the --freq <freq> is passed with the
                                --tables-path, and the --input-path, and the input-path points to raw unprocessed E3SM files, then an additional check will me made for if the required raw variables are present in the E3SM output.
        --version             print the version number and Exit

Variable List
^^^^^^^^^^^^^
The "--var-list" or "-v" flag is a mandatory option, and should be a list of CMIP6 variable names to be output. The value "all" can also be used, which will cause
the package to do its best to process all variables it can, given the contents of the input directory. 

Input Path
^^^^^^^^^^
This mandatory flag should point at a directory containing the data files to be processed. 

Output Path
^^^^^^^^^^^
This mandatory flag is the location that all output files will be placed. The main output is a directory named CMIP6, which contains the CMIP6
directory structure, with the output files as leaf nodes. Other output files include a copy of the user metadata (if present), and a directory named 
cmor_logs containing the per-variable log files generated by CMOR.

Simple
^^^^^^
This optional flag will cause the tool to run without needing or checking for the custom CMIP metadata usually required for processing. Output from this mode
use the same converter code as the default mode, but the output doesnt contain the required metadata needed for a CMIP publication. This mode should be used 
when the output is intended for analysis, but is not suited for publication.

Frequency
^^^^^^^^^
The "--freq" and "-f" flags can be used to process high-frequency datasets. By default the tool assumes its working with monthly data. The following submonthly frequencies 
are supported: [6hr, 6hrLev, 6hrPlev, 3hr, day]

User Input Metadata
^^^^^^^^^^^^^^^^^^^
The "--user-metadata" or "-u" flag should be the path to a json formatted metadata file containing CMIP6 metadata for the case being processed. This flag can be avoided for
non-official data by using the "--simple" flag. Otherwise, the file should look something like the metadata files `that can be found here <https://github.com/E3SM-Project/CMIP6-Metadata>`_

Tables Path
^^^^^^^^^^^
The "--tables-path" or "-t" flag should point to the "Tables" directory of the CMIP6 controlled vocabulary repository. 
The repository `can be found here <https://github.com/PCMDI/cmip6-cmor-tables/>`_

Mpas mapfile
^^^^^^^^^^^^
When processing MPAS ocean or sea-ice variables, a mapfile is needed for regridding. Use the "--map" flag to pass the path to this mapfile.


Numproc
^^^^^^^
By default, the variable converters are run in parallel using a process pool with 6 worker processes. The "--num-proc" or "-n" flag can be used to control the number
of simultaneously executing processes. For example, 3D ocean fields take significantly more RAM then other variables, so the number of converters running at once
may be reduced to accommodate the machine being used.

Handler Path
^^^^^^^^^^^^
A directory of custom variable handlers can be passed using the "--handlers" or "-H" flag.

Custom Metadata
^^^^^^^^^^^^^^^
Additional custom metadata can be added to the global attributes of the output files by using the "--custom-metadata" flag to point to a json formatted
file containing the metadata key value pairs.

Serial
^^^^^^
For debugging purposes, or when running in a resource constrained environment, the "--serial" or "-s" boolean flag can be used to cause the conversion process
to be run in serial, using the main process.

Data Mode
^^^^^^^^^

The type of data being operated on should be specified using the "--mode" flag. Allowed values are "atm", "lnd", "mpaso" and "mpassi." This is needed so that the package
can correctly determine what type of input files to look for.

Info
^^^^

The "--info" flag can be used in three different ways to determine information about the variables being requested for processing. In the simplest form, passing only
the "--info" and "--var-list" flags will return information about the required input and CMIP6 output names of the variables passed in the variable list.

If the --freq <frequency> is passed along with the --tables-path, then the CMIP6 tables will get checked to see if the requested variables are present in the CMIP6 table matching the freq.

If the --freq <freq> is passed with the --tables-path, and the --input-path, and the input-path points to raw unprocessed E3SM files, then an additional check will me made for if the required raw variables are present in the E3SM output.
In this last mode, instead of passing a directory of time-series files as the input path, pass the path to raw unprocessed E3SM cam or eam files.
